# SPDX-License-Identifier: MIT
#
# Copyright 2025 bniladridas. All rights reserved.
# Use of this source code is governed by a MIT license that can be
# found in the LICENSE file.

name: Flutter CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    - uses: ./.github/actions/setup-flutter
      with:
        flutter-version: '3.38.3'
    - run: flutter pub get
    - run: flutter analyze
    - run: flutter test
    - run: ./run_e2e.sh
    - run: flutter build macos
    - name: Label PR based on changes
      if: github.event_name == 'pull_request'
      run: |
        # Get commit messages from the PR
        COMMITS=$(gh pr view ${{ github.event.number }} --json commits -q '.commits[].message')

        # Determine label
        if echo "$COMMITS" | grep -q "BREAKING CHANGE"; then
          LABEL="major"
        elif echo "$COMMITS" | grep -q "^feat:"; then
          LABEL="minor"
        elif echo "$COMMITS" | grep -q "^fix:"; then
          LABEL="patch"
        else
          LABEL="patch"  # default
        fi

        # Add label if not already present
        if ! gh pr view ${{ github.event.number }} --json labels -q '.labels[].name' | grep -q "^${LABEL}$"; then
          gh pr edit ${{ github.event.number }} --add-label "$LABEL"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
